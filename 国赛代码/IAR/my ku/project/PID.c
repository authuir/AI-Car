#include "all.h"
float input = 0, input_sum = 0, input_dif = 0, output = 0;
//middle 
float middle_sum_max = 20, middle_sum_min = -20, middle_input_last = 0,middle_previe=0, middle_sum = 0;
//k
float k_sum_max = 20, k_sum_min = -20, k_input_last = 0, k_sum = 0, k_output = 0;
//speed        
float speed_sum_max = 10000, speed_sum_min = -10000, speed_last_error1 = 0,speed_last_twoerror1=0,speed_last_error2=0,speed_last_twoerror2=0,speed_error2=0,speed_error1 = 0;
//差速PID
float sub_a=1.02,sub_k=1;
//差速减速PID
float sub_slow = 1.2;
uint8 close_motor=0;
float middle_p=5,middle_d=7,k_p=400,speed_p=10,sub_p=1,k_ptemp,speed_i=0.004,speed_d=0,min_speed=18;
float get_servo=0,middle_input=0;
float middle_Ap = 1.0;

const  float Servo_KP[] = {1.321320,1.319514,1.317716,1.315924,1.314139,1.312361,1.310589,1.308824,1.307066,1.305315,1.303570,1.301833,1.300101,1.298377,1.296659,1.294947,1.293243,1.291544,1.289853,1.288168,1.286489,1.284817,1.283151,1.281492,1.279839,1.278193,1.276553,1.274919,1.273292,1.271671,1.270057,1.268448,1.266846,1.265251,1.263661,1.262078,1.260501,1.258930,1.257365,1.255807,1.254254,1.252708,1.251168,1.249633,1.248105,1.246583,1.245067,1.243557,1.242053,1.240555,1.239063,1.237576,1.236096,1.234621,1.233153,1.231690,1.230233,1.228782,1.227336,1.225897,1.224463,1.223035,1.221612,1.220195,1.218784,1.217379,1.215979,1.214585,1.213196,1.211813,1.210436,1.209064,1.207697,1.206336,1.204981,1.203631,1.202286,1.200947,1.199614,1.198285,1.196962,1.195645,1.194332,1.193025,1.191724,1.190427,1.189136,1.187850,1.186569,1.185294,1.184023,1.182758,1.181498,1.180243,1.178993,1.177748,1.176509,1.175274,1.174044,1.172820,1.171600,1.170385,1.169176,1.167971,1.166771,1.165576,1.164385,1.163200,1.162020,1.160844,1.159673,1.158507,1.157346,1.156189,1.155037,1.153890,1.152747,1.151609,1.150476,1.149347,1.148223,1.147104,1.145989,1.144879,1.143773,1.142672,1.141575,1.140482,1.139394,1.138311,1.137232,1.136157,1.135087,1.134021,1.132959,1.131902,1.130849,1.129800,1.128756,1.127716,1.126680,1.125648,1.124620,1.123597,1.122577,1.121562,1.120551,1.119544,1.118541,1.117542,1.116548,1.115557,1.114570,1.113587,1.112608,1.111633,1.110662,1.109695,1.108731,1.107772,1.106816,1.105865,1.104917,1.103972,1.103032,1.102095,1.101162,1.100233,1.099307,1.098385,1.097467,1.096552,1.095641,1.094734,1.093830,1.092930,1.092033,1.091140,1.090250,1.089363,1.088481,1.087601,1.086725,1.085853,1.084983,1.084118,1.083255,1.082396,1.081540,1.080687,1.079838,1.078992,1.078149,1.077309,1.076473,1.075640,1.074809,1.073982,1.073159,1.072338,1.071520,1.070705,1.069894,1.069085,1.068279,1.067477,1.066677,1.065880,1.065087,1.064296,1.063508,1.062722,1.061940,1.061161,1.060384,1.059610,1.058839,1.058071,1.057305,1.056542,1.055782,1.055024,1.054269,1.053517,1.052767,1.052020,1.051276,1.050534,1.049795,1.049058,1.048323,1.047591,1.046862,1.046135,1.045411,1.044688,1.043969,1.043251,1.042536,1.041824,1.041113,1.040405,1.039699,1.038996,1.038295,1.037595,1.036899,1.036204,1.035511,1.034821,1.034133,1.033446,1.032762,1.032080,1.031400,1.030722,1.030046,1.029372,1.028700,1.028030,1.027362,1.026696,1.026031,1.025369,1.024708,1.024049,1.023393,1.022737,1.022084,1.021432,1.020782,1.020134,1.019488,1.018843,1.018200,1.017558,1.016919,1.016280,1.015644,1.015009,1.014375,1.013743,1.013113,1.012484,1.011856,1.011230,1.010605,1.009982,1.009360,1.008740,1.008121,1.007503,1.006886,1.006271,1.005657,1.005045,1.004433,1.003823,1.003214,1.002607,1.002000,1.001395,1.000790,1.000187,0.999585,0.998984,0.998384,0.997785,0.997187,0.996590,0.995994,0.995399,0.994805,0.994212,0.993620,0.993028,0.992438,0.991848,0.991259,0.990671,0.990084,0.989498,0.988912,0.988327,0.987743,0.987159,0.986576,0.985994,0.985412,0.984831,0.984251,0.983671,0.983092,0.982513,0.981935,0.981357,0.980780,0.980203,0.979626,0.979050,0.978475,0.977900,0.977325,0.976750,0.976176,0.975603,0.975029,0.974456,0.973883,0.973310,0.972738,0.972165,0.971593,0.971021,0.970449,0.969877,0.969306,0.968734,0.968162,0.967591,0.967020,0.966448,0.965877,0.965305,0.964733,0.964162,0.963590,0.963018,0.962446,0.961874,0.961302,0.960729,0.960157,0.959584,0.959011,0.958437,0.957863,0.957289,0.956715,0.956140,0.955565,0.954990,0.954414,0.953838,0.953261,0.952684,0.952107,0.951529,0.950950,0.950371,0.949791,0.949211,0.948630,0.948049,0.947467,0.946884,0.946301,0.945716,0.945132,0.944546,0.943960,0.943373,0.942785,0.942197,0.941607,0.941017,0.940426,0.939834,0.939241,0.938648,0.938053,0.937457,0.936861,0.936263,0.935664,0.935065,0.934464,0.933862,0.933260,0.932656,0.932051,0.931444,0.930837,0.930228,0.929619,0.929008,0.928396,0.927782,0.927167,0.926551,0.925934,0.925315,0.924695,0.924074,0.923451,0.922827,0.922202,0.921575,0.920946,0.920316,0.919684,0.919051,0.918417,0.917781,0.917143,0.916504,0.915863,0.915220,0.914576,0.913930,0.913282,0.912633,0.911982,0.911329,0.910675,0.910018,0.909360,0.908700,0.908038,0.907375,0.906709,0.906042,0.905372,0.904701,0.904028,0.903352,0.902675,0.901996,0.901314,0.900631,0.899945,0.899258,0.898568,0.897876,0.897182,0.896486,0.895788,0.895087,0.894384,0.893679,0.892972,0.892262,0.891550,0.890836,0.890120,0.889401,0.888679,0.887956,0.887229,0.886501,0.885770,0.885036,0.884300,0.883562,0.882821,0.882077,0.881331,0.880582,0.879831,0.879077,0.878320,0.877561,0.876799,0.876034,0.875266,0.874496,0.873723,0.872948,0.872169,0.871388,0.870603,0.869816,0.869026,0.868234,0.867438,0.866639,0.865837,0.865033,0.864225,0.863415,0.862601,0.861784,0.860964,0.860142,0.859316,0.858487,0.857654,0.856819,0.855980,0.855139,0.854294,0.853445,0.852594,0.851739,0.850881,0.850020,0.849155,0.848287,0.847415,0.846540,0.845662,0.844780,0.843895,0.843007,0.842114,0.841219,0.840320,0.839417,0.838511,0.837601,0.836688,0.835770,0.834850,0.833925,0.832997,0.832066,0.831130,0.830191,0.829248,0.828301,0.827351,0.826396,0.825438,0.824476,0.823510,0.822541,0.821567,0.820589,0.819608,0.818622,0.817633,0.816639,0.815642,0.814640,0.813634,0.812625,0.811611,0.810593,0.809571,0.808545,0.807514,0.806480,0.805441,0.804398,0.803350,0.802299,0.801243,0.800183,0.799118,0.798050,0.796976,0.795899,0.794817,0.793730,0.792640,0.791544,0.790444,0.789340,0.788231,0.787118,0.786000};

float middle_PID_control(float p, float i, float d)
{
	float  middle_output = 0;
#if 1
	
	middle_previe=middle_input_last;
	middle_input_last = middle_input;
	middle_input=get_servo-161;
	middle_sum += middle_input;
	if (middle_sum>middle_sum_max) middle_sum = middle_sum_max;
	else if (middle_sum<middle_sum_min) middle_sum = middle_sum_min;
    //此处有BUG
	//if(get_servo>Y_MAX_OUT/2)
#if   0   //根据偏差给P
		p=p+0.5*0.001*(get_servo-Y_MAX_OUT/2)*(get_servo-Y_MAX_OUT/2);//平方  不同斜率下的P的函数
#else
        if(driver==0) p=3.5;
        else       p=p*((count_pwm1+count_pwm2)/2/driver) * middle_Ap;
     if(p<4) p=4;
#endif
     
	
	middle_output = p*middle_input + i*middle_sum + d*(middle_input-middle_input_last);
#else
	middle_output = 175 * k_output;
#endif
	return middle_output;
}



float  driver = 85;float speed_output = 0,desier_driver1=0,desier_driver2=0;
extern float input_servor;
float PID_control_k(float p, float i, float d)
{
	float ka_output, k_sum = 0, input_error = 0;
	input_error = k_output;
	k_sum += input_error;
	if (k_sum >= k_sum_max) k_sum = k_sum_max;
	else if (k_sum <= k_sum_min) k_sum = k_sum_min;
	//p=p*(count_pwm2/desier_driver1+count_pwm1/desier_driver2)/2;//速度和p关系
	//if(p<100) p=100;
	ka_output = p*input_error + i*k_sum + d*(input_error - k_input_last);
	k_input_last = input_error;
	return ka_output;
}
extern uint16 type;
extern uint8 Ready_Stop;
void desier_get(float p_k,float a,float k) //获得期望速度
{
	float k_in;
	if(k_output>0) k_in=k_output;
	else k_in=k_output/-1;
    float driver_temp=driver;
    
    if(close_motor==0)
     {
         switch(mode_select)
          {
          case 1:
          case 2:
              if(((angle_type!=0)||(type==7)))driver_temp=45;
              break;
          case 3:
              if(((angle_type!=0)||(type==7)))driver_temp=45;
              if(type==4) driver_temp=70;
              break;
          case 4:
              if(((angle_type!=0)||(type==7)))driver_temp=45;
              if(type==4) driver_temp=50;
              break;
          }
     }
    
    if(Ready_Stop ) 
     {
         if(driver_temp>75) driver_temp=75;
     }
#if 1
	driver_temp=driver_temp*(1-k_in*p_k);
    if(driver_temp<0) driver_temp=0;
	if(close_motor==0)
	{
		if(driver_temp<50) driver_temp=50;
	}
#if 0   //单次拟合
    if(input_servor>500)
     {
         desier_driver1=driver_temp*(a*((-0.0008046*(1000-input_servor) + 0.424))+1);
         desier_driver2=driver_temp/(a*((-0.0008046*(1000-input_servor) + 0.424))+1);//差速
     }
    else
     {
         desier_driver1=driver_temp/(a*(-0.0008046*input_servor + 0.424)+1);
         desier_driver2=driver_temp*(a*(-0.0008046*input_servor + 0.424)+1);//差速
     } 
#else    //查表拟合
    
    desier_driver2=driver_temp*Servo_KP[(int)(input_servor-200)];
    desier_driver1=driver_temp/Servo_KP[(int)(input_servor-200)];
    
#endif
	if(desier_driver1<0) desier_driver1=0;
	if(desier_driver2<0) desier_driver2=0;
#endif
}
float motor_1=10,motor_2=10;
void PID_speed(float p1, float i1, float d1, float p2, float i2, float d2)
{
#if 1
	//motor1
	float motor_pwm1, motor_pwm2, motor_pwm3, motor_pwm4;
	speed_last_twoerror1=speed_last_error1;
	speed_last_error1 = speed_error1;
	speed_error1=desier_driver1-count_pwm1 ;
	if(close_motor==1)
	{
		i1*=20;i2*=20;
	}
	motor_1+=p1*(speed_error1- speed_last_error1)+ d1*((speed_error1-speed_last_error1)-(speed_last_error1-speed_last_twoerror1));
	
	
	if(motor_1>0) {motor_pwm1=motor_1;motor_pwm2=0;}
	else {motor_pwm1=0;motor_pwm2=motor_1/-1;}
	
	//motor2 
	speed_last_twoerror2=speed_last_error2;
	speed_last_error2 = speed_error2;
	speed_error2=desier_driver2-count_pwm2 ;
	
	motor_2+=p2*(speed_error2- speed_last_error2)+d2*((speed_error2-speed_last_error2)-(speed_last_error2-speed_last_twoerror2)); 
	if(motor_2>0) {motor_pwm3=motor_2;motor_pwm4=0;}
	else {motor_pwm3=0;motor_pwm4=motor_2/-1;}
	
	motor_pwm1/=2;motor_pwm2/=2;motor_pwm3/=2;motor_pwm4/=2;
	if(motor_pwm1>99)  motor_pwm1=99;
	if(motor_pwm2>99)  motor_pwm2=99;
	if(motor_pwm3>99)  motor_pwm3=99;
	if(motor_pwm4>99)  motor_pwm4=99;
#if 0       //被动差速
	if(k_output>0) motor_pwm1=motor_pwm3;
	else motor_pwm3=motor_pwm1;
#endif
	motor_dutyset(motor_pwm1, motor_pwm2, motor_pwm3, motor_pwm4);
	
#endif  
}